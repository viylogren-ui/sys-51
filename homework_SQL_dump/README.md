# Домашнее задание к занятию "`Резервное копирование баз данных`" - `Ренёв Виаталий`


### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

---

### Решение 1. Резервное копирование

1.1. `В соответствии с заданием компания рассчитала, что параметр RPO (Recovery Point Objective) равняется 24 часам. Сопоставив с точки зрения критичности потери данных (финансовые, репутационные, юридические и другие риски) с техническими возможностями системы (объемы физического хранилища данных, сетевой пропускной способности, нагрузки на СУБД во время горячего резервного копирования), а также проанализировав периодичность обновлений и объем изменяемых данных определила, что нельзя допустить потери данных сроком более чем за 24 часа после сбоя сервера при восстановлении.`
`     Для решения такой задачи на сервере вполне достаточно создать задание в планировщике задач на полное резервное копирование данных в ночное время один раз в сутки.`

1.2. `Для резервирования информации в БД, при условии необходимости возможности восстановления системы за час до предполагаемой поломки, целесообразно использовать дифференциальный подход, при котором ежечасно в горячем режиме будут копироваться только новые и измененные с момента создания предыдущей копии данные. Такой подход позволит значительно сэкономить место в системе хранения данных и повысить скорость по сравнению с полным ежечасным бэкапом.`
`     При этом, в связи с тем, что дифференциальный подход является накопительным и при восстановлении системы после сбоя потребуется восстанавливать последний созданный полный бэкап и последний дифференциальный, целесообразно предусмотреть также периодическое создание полной копии БД, например два раза в неделю, в ночное время.`

1.3.* `Для решения задачи переключения на работающую базу данных при поломке основной целесообразно использовать механизмы репликации. На основном master-сервере будет "крутиться" основная БД, а на slave-сервер будут постоянно в режиме рельаного времени поступать инкрементные бэкапы. При выходе из строя БД на основном сервере пользователи получат доступ к одной из реплик на slave-серверах. При этом, т.к. slave-сервера предназначены только для чтения с них данных, необходимо предусмотреть возможность, чтобы slave-сервер взял на себя роль мастера, чтобы у пользователей была возможность вносить изменения в базу данных до восстановления основного сервера.`

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

### Решение 2. PostgreSQL

2.1. `В утилите pg_dump параметр --data-only позволяет выгружать только данные, но не схемы объектов (DDL) или статистику. Будут выгржаться данные таблиц, большие объекты и значения последовательностей.`
`Экспорт только данных БД my.db под пользователем postgres:`
```
pg_dump -U postgres --data-only my.db > mydb.sql
```

`Для восстановления БД с помощью команды pg_restore надо исползовать ключи -Fc (format, custom) при экспорте. Так мы выгрузим данные в специальном архивном формате, пригодном для дальнешего использования с утилитой pg_restore.`
`Пример команды для выгрузки в специальном формате:`
```
pg_dump -U postgres -Fc my.db > mydb.dump

```
`Восстановление с помощью утилиты pg_restore`
```
pg_restore -с -C -d postgres mydb.dump
```

`В параметре -d (--dbname) указывается любая существующая БД. pg_restore использует ее только для того, чтобы выполнить команду CREATE DATABASE для базы mydb. параметр -с (--clean )позволяет выполнить DROP для восстанавливаемых объектов БД. С параметром -C (--create) данные восстанавливаются в БД, имя которой записано в файле архива. `

2.1* `Автоматизировать процесс выгрузки и восстановления баз данных возможно с использованием bash-скриптов и создания задания на выполнение скрипта в планировщике задач.`
`Пример:`
```
#!/bin/bash
TIMESTAMP=$(date +%F-%H-%M)
BACKUP_DIR="/var/backups/pgsql"
DB_NAME="mydb"
USER="postgres"

mkdir -p $BACKUP_DIR
pg_dump -U $USER $DB_NAME > $BACKUP_DIR/${DB_NAME}_${TIMESTAMP}.sql

Чтобы запускать его каждую ночь, добавляем строку в crontab:

0 2 * * * /usr/local/bin/pgsql_backup.sh
```

`Второй вариант - использование специальных утилит, таких как Barman, pgBackRest, Wal-G.`


### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

### Решение 3. MySQL

3.1. `В MySQL реализовать инкрементное копирование возможно с помощью резервного копирования двоичных файлов журнала. Все транзакции, применяемые к серверу MySQL, последовательно записываются в двоичные файлы журнала, cледовательно, можно восстановить исходную базу данных из этих файлов.`
`     Для реализации такой стратегии необходимо включить ведение двоичных журналов в файле конфигурации mysql.cnf:`
```
nano /etc/mysql/mysql.cnf
```
`Указать значение параметров log-bin, expire_log_days, max_binlog_size в файле конфигурации, например:`

```
server_id = 1
log_bin = /var/log/mysql/mysql-bin.log
inlog_expire_logs_seconds = 2592000
max_binlog_size = 100M
```

`После перезапуска сервиса mysql необходимо создать полную резервную копию с помощью утилиты mysqldump используя параметры --flush-log и  --delete-master-logs, --delete-master-logs удалит старые двоичные файлы журнала, а --flush-log инициализирует запись нового двоичного файла журнала. Результаты целесообразно заархивировать.`
```
mysqldump --flush-logs --delete-master-logs --single-transaction --all-databases | gzip > /var/backups/mysql/$(date +%d-%m-%Y_%H-%M-%S)-archiv.gz`
```